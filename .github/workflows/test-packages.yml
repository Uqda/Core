name: Test Packages

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/test-packages.yml'
      - 'contrib/**'
      - 'cmd/**'
      - 'build'
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-linux-debian:
    name: Test Linux Debian Package
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
      - name: Build Debian package
        env:
          PKGARCH: ${{ matrix.arch }}
        run: |
          chmod +x build contrib/deb/generate.sh contrib/semver/*.sh
          sh contrib/deb/generate.sh
      
      - name: Find package file
        id: find_pkg
        run: |
          PKG=$(ls -1 *.deb | head -n 1)
          echo "package=$PKG" >> $GITHUB_OUTPUT
          echo "Package found: $PKG"
          ls -lh *.deb
      
      - name: Install package
        run: |
          sudo dpkg -i ${{ steps.find_pkg.outputs.package }} || sudo apt-get install -f -y
          sudo dpkg -i ${{ steps.find_pkg.outputs.package }}
      
      - name: Verify binaries exist
        run: |
          which uqda || (echo "uqda binary not found in PATH" && exit 1)
          which uqdactl || (echo "uqdactl binary not found in PATH" && exit 1)
          uqda -version || (echo "uqda -version failed" && exit 1)
          uqdactl -help || (echo "uqdactl -help failed" && exit 1)
      
      - name: Check systemd service file
        run: |
          test -f /etc/systemd/system/uqda.service || test -f /lib/systemd/system/uqda.service || (echo "systemd service file not found" && exit 1)
          echo "✓ systemd service file exists"
      
      - name: Test configuration generation
        run: |
          sudo mkdir -p /etc/uqda
          sudo uqda -genconf > /tmp/test-uqda.conf || (echo "Failed to generate config" && exit 1)
          test -s /tmp/test-uqda.conf || (echo "Generated config is empty" && exit 1)
          echo "✓ Configuration generation works"
      
      - name: Test uqdactl commands
        run: |
          # Test getSelf (may fail if service not running, that's OK)
          sudo uqdactl getSelf || echo "Note: getSelf requires running service"
          # Test help
          uqdactl -help | grep -q "Usage" || (echo "uqdactl help failed" && exit 1)
          echo "✓ uqdactl commands work"
      
      - name: Test service status
        run: |
          sudo systemctl status uqda || echo "Service not running (expected if no config)"
          echo "✓ Service can be queried"
      
      - name: Test package removal
        run: |
          sudo dpkg -r uqda-v0.1.0 || sudo apt-get remove -y uqda-v0.1.0 || true
          echo "✓ Package removal works"

  test-windows:
    name: Test Windows MSI Package
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
      
      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v4
      
      - name: Build Windows MSI
        run: |
          bash -c "chmod +x build contrib/msi/build-msi.sh contrib/semver/*.sh"
          bash contrib/msi/build-msi.sh ${{ matrix.arch }}
      
      - name: Find package file
        id: find_pkg
        shell: bash
        run: |
          PKG=$(ls -1 *.msi | head -n 1)
          echo "package=$PKG" >> $GITHUB_OUTPUT
          echo "Package found: $PKG"
          ls -lh *.msi
      
      - name: Install MSI package
        shell: powershell
        run: |
          $package = "${{ steps.find_pkg.outputs.package }}"
          Write-Host "Installing: $package"
          Start-Process msiexec.exe -Wait -ArgumentList "/i `"$package`" /quiet /norestart /L*v install.log"
          if ($LASTEXITCODE -ne 0) {
            Get-Content install.log
            exit 1
          }
          Write-Host "✓ Installation completed"
      
      - name: Verify binaries exist
        shell: powershell
        run: |
          $uqdaPath = "C:\Program Files\Uqda\uqda.exe"
          $uqdactlPath = "C:\Program Files\Uqda\uqdactl.exe"
          
          if (-not (Test-Path $uqdaPath)) {
            Write-Error "uqda.exe not found at $uqdaPath"
            exit 1
          }
          if (-not (Test-Path $uqdactlPath)) {
            Write-Error "uqdactl.exe not found at $uqdactlPath"
            exit 1
          }
          
          Write-Host "✓ Binaries found"
          & $uqdaPath -version
          & $uqdactlPath -help
      
      - name: Test configuration generation
        shell: powershell
        run: |
          $configDir = "C:\ProgramData\Uqda"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          
          & "C:\Program Files\Uqda\uqda.exe" -genconf | Out-File -FilePath "$configDir\test-uqda.conf" -Encoding utf8
          
          if (-not (Test-Path "$configDir\test-uqda.conf")) {
            Write-Error "Failed to generate config"
            exit 1
          }
          
          $content = Get-Content "$configDir\test-uqda.conf" -Raw
          if ([string]::IsNullOrWhiteSpace($content)) {
            Write-Error "Generated config is empty"
            exit 1
          }
          
          Write-Host "✓ Configuration generation works"
      
      - name: Test uqdactl commands
        shell: powershell
        run: |
          $uqdactl = "C:\Program Files\Uqda\uqdactl.exe"
          
          # Test help
          $help = & $uqdactl -help 2>&1
          if ($help -notmatch "Usage") {
            Write-Error "uqdactl help failed"
            exit 1
          }
          
          Write-Host "✓ uqdactl commands work"
      
      - name: Test service status
        shell: powershell
        run: |
          $service = Get-Service -Name "Uqda" -ErrorAction SilentlyContinue
          if ($service) {
            Write-Host "Service status: $($service.Status)"
          } else {
            Write-Host "Service not installed (expected if no config)"
          }
          Write-Host "✓ Service can be queried"
      
      - name: Test package removal
        shell: powershell
        run: |
          $package = "${{ steps.find_pkg.outputs.package }}"
          Start-Process msiexec.exe -Wait -ArgumentList "/x `"$package`" /quiet /norestart"
          Write-Host "✓ Package removal works"

  test-macos:
    name: Test macOS PKG Package
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
      
      - name: Build macOS PKG
        env:
          PKGARCH: ${{ matrix.arch }}
        run: |
          chmod +x build contrib/macos/create-pkg.sh contrib/semver/*.sh
          sh contrib/macos/create-pkg.sh
      
      - name: Find package file
        id: find_pkg
        run: |
          PKG=$(ls -1 *.pkg | head -n 1)
          echo "package=$PKG" >> $GITHUB_OUTPUT
          echo "Package found: $PKG"
          ls -lh *.pkg
      
      - name: Install PKG package
        run: |
          sudo installer -pkg "${{ steps.find_pkg.outputs.package }}" -target /
          if [ $? -ne 0 ]; then
            echo "Installation failed"
            exit 1
          fi
          echo "✓ Installation completed"
      
      - name: Verify binaries exist
        run: |
          if [ ! -f /usr/local/bin/uqda ]; then
            echo "uqda binary not found at /usr/local/bin/uqda"
            exit 1
          fi
          if [ ! -f /usr/local/bin/uqdactl ]; then
            echo "uqdactl binary not found at /usr/local/bin/uqdactl"
            exit 1
          fi
          
          /usr/local/bin/uqda -version || (echo "uqda -version failed" && exit 1)
          /usr/local/bin/uqdactl -help || (echo "uqdactl -help failed" && exit 1)
          echo "✓ Binaries found and executable"
      
      - name: Check launchd plist file
        run: |
          if [ ! -f /Library/LaunchDaemons/uqda.plist ]; then
            echo "launchd plist file not found at /Library/LaunchDaemons/uqda.plist"
            ls -la /Library/LaunchDaemons/ | grep -i uqda || echo "No uqda files found in LaunchDaemons"
            exit 1
          fi
          echo "✓ launchd plist file exists"
          
          # Validate plist syntax
          plutil -lint /Library/LaunchDaemons/uqda.plist || (echo "plist syntax error" && exit 1)
          echo "✓ plist syntax is valid"
          
          # Check plist content
          grep -q "network.uqda.uqda" /Library/LaunchDaemons/uqda.plist || (echo "plist Label incorrect" && exit 1)
          echo "✓ plist content is correct"
      
      - name: Test configuration generation
        run: |
          sudo mkdir -p /etc/uqda
          sudo /usr/local/bin/uqda -genconf > /tmp/test-uqda.conf || (echo "Failed to generate config" && exit 1)
          test -s /tmp/test-uqda.conf || (echo "Generated config is empty" && exit 1)
          echo "✓ Configuration generation works"
      
      - name: Test uqda -autoconf
        run: |
          # Test autoconf (creates config and starts service)
          sudo /usr/local/bin/uqda -autoconf || echo "Note: autoconf may require user interaction"
          echo "✓ autoconf command works"
      
      - name: Test uqdactl commands
        run: |
          # Test getSelf (may fail if service not running, that's OK)
          sudo /usr/local/bin/uqdactl getSelf || echo "Note: getSelf requires running service"
          
          # Test help
          /usr/local/bin/uqdactl -help | grep -q "Usage" || (echo "uqdactl help failed" && exit 1)
          echo "✓ uqdactl commands work"
      
      - name: Test launchd service
        run: |
          # Check if service can be loaded (may fail if already loaded, that's OK)
          sudo launchctl list | grep -q "network.uqda.uqda" || echo "Service not loaded (expected if no config)"
          
          # Test service status using correct label
          sudo launchctl list network.uqda.uqda 2>/dev/null || echo "Service not running (expected if no config)"
          echo "✓ launchd service can be queried"
      
      - name: Check file permissions
        run: |
          # Check binary permissions
          ls -l /usr/local/bin/uqda
          ls -l /usr/local/bin/uqdactl
          
          # Verify binaries are executable
          test -x /usr/local/bin/uqda || (echo "uqda is not executable" && exit 1)
          test -x /usr/local/bin/uqdactl || (echo "uqdactl is not executable" && exit 1)
          echo "✓ File permissions are correct"
      
      - name: Test package removal
        run: |
          # Unload service if running
          sudo launchctl unload /Library/LaunchDaemons/uqda.plist 2>/dev/null || true
          sudo launchctl bootout system/network.uqda.uqda 2>/dev/null || true
          
          # Remove files
          sudo rm -f /usr/local/bin/uqda
          sudo rm -f /usr/local/bin/uqdactl
          sudo rm -f /Library/LaunchDaemons/uqda.plist
          
          echo "✓ Package removal works"
      
      - name: Check architecture compatibility
        run: |
          ARCH=$(uname -m)
          PKG_ARCH="${{ matrix.arch }}"
          
          echo "System architecture: $ARCH"
          echo "Package architecture: $PKG_ARCH"
          
          # On Apple Silicon, both arm64 and amd64 (via Rosetta) should work
          if [ "$ARCH" = "arm64" ] && [ "$PKG_ARCH" = "amd64" ]; then
            echo "✓ Testing Intel package on Apple Silicon (Rosetta compatibility)"
          elif [ "$ARCH" = "arm64" ] && [ "$PKG_ARCH" = "arm64" ]; then
            echo "✓ Testing native Apple Silicon package"
          elif [ "$ARCH" = "x86_64" ] && [ "$PKG_ARCH" = "amd64" ]; then
            echo "✓ Testing native Intel package"
          else
            echo "⚠ Architecture mismatch (may still work via Rosetta)"
          fi

  all-tests-passed:
    name: ✅ All Package Tests Passed
    needs: [test-linux-debian, test-windows, test-macos]
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}
    steps:
      - name: Verify all tests passed
        run: |
          echo "✅ All package tests passed successfully!"
          echo ""
          echo "Tested platforms:"
          echo "  - Linux (Debian/Ubuntu) - amd64, arm64"
          echo "  - Windows - x64, arm64"
          echo "  - macOS - amd64, arm64"
          echo ""
          echo "All packages install correctly and binaries work as expected."

